<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                jax: ["input/TeX","output/SVG", "output/PreviewHTML"],
                extensions: ["tex2jax.js"],
                TeX: {
                    extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
                }
            });
            MathJax.Hub.Config({
                SVG: {
                    linebreaks: { automatic: true },
                    font: "TeX",
                    blacker: 0.1,
                    useFontCache: true,
                    useGlobalCache: false,
                    EqnChunkDelay: 100
                }
            });
            MathJax.Hub.Register.StartupHook("End Jax",function () {
                return MathJax.Hub.setRenderer( "SVG" );
            });
        </script>
        <style type="text/css">
            #template, #drawing {
                display: inline-block;
                border: solid 1px black;
            }

            #template > svg, #drawing > svg {
                display: block;
            }

            #placeholder_surface, #placeholder_equation {
                fill: LightGray;
            }

            #template {
                display: none;
            }

            #equation_wrapper {
                background-color:red;
                width:30ex;
                display: none;
            }
        </style>
    </head>
    <body>
        <script>
            var allLibs = {
                "SURFER": [
                    "fileinjar:///META-INF/resources/webjars/Snap.svg/0.4.1/snap.svg-min.js",
                    "fileinjar:///META-INF/resources/webjars/mathjax/2.7.1/MathJax.js"
                ],
                "online": [
                    "https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js",
                    "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"
                ]
            };
            var libs = allLibs[ navigator.userAgent.startsWith( "SURFER" ) ? "SURFER" : "online" ];
            libs.forEach( function( lib ) {
                // The following loads the script synchronously.
                // It is bad practice, but at least it works.
                var script = document.createElement('script');
                script.setAttribute( 'src', lib );
                script.setAttribute( 'type', 'text/javascript' );
                document.write( script.outerHTML );
            });
        </script>
        <div id="template">
            <svg height="848.5281374238571" width="600" xmlns:svgjs="http://svgjs.com/svgjs" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg">
                <rect x="25" y="60" height="550" width="550" id="placeholder_surface"></rect>
                <rect x="25" y="650" height="170" width="550" id="placeholder_equation"></rect>
            </svg>
        </div>
        <div id="drawing"></div>
        <div id="equation_wrapper">$$0$$</div>
        <script type="text/javascript">
                var image_url = null;
                var equation_wrapper = document.getElementById('equation_wrapper');
        		var equation = null;
                var width_ex = 30;
                var external_callback = null;

                function svgSourceWithXlinkHref( svgElem )
                {
                    // fix image tag: replace href with xlink:href
                    var images = svgElem.querySelectorAll( "image" );
                    images.forEach( function( image ) {
                        image = image.cloneNode( true );
                        image.setAttribute( "xlink:href", image.getAttribute( "href" ) );
                        image.removeAttribute( "href" );
                    });
                    return svgElem.outerHTML;
                }

                function mathjaxCallback() {
                    if( isLaTeXOneLine() || getPlaceholderAspectRatio() - getLaTeXAspectRatio() < 0.1 )
                    {
                        var svgElem = document.getElementById( "drawing" ).firstChild;
                        composeSVG( svgElem );
                        external_callback( svgElem );
                    }
                    else
                    {
                        width_ex += 5;
                        equation_wrapper.style.width = width_ex + "ex";
                        console.log( "typesetting again at width of " + width_ex + "ex" );
                        MathJax.Hub.Queue(['Reprocess', equation, mathjaxCallback ]);
                    }
        		}

                function getPlaceholderAspectRatio()
                {
                    var bbox = Snap( document.getElementById( "template" ).children[ 0 ] )
                        .select( "#placeholder_equation" )
                        .getBBox();
                    return bbox.w / bbox.h;
                }

                function isLaTeXOneLine()
                {
                    // I am more or less guessing here, but it should work for simple
                    // polynomial equations
                    return getLaTeXBBox().h < 1500;
                }

                function getLaTeXBBox()
                {
                    return Snap( document.getElementById(equation.root.inputID+'-Frame').firstChild ).getBBox();
                }

                function getLaTeXAspectRatio()
                {
                    var bbox = getLaTeXBBox();
                    return bbox.w / bbox.h;
                }

                function composeSVG( svgElement )
                {
                    var snap = Snap( svgElement );
                    var placeholder_surface = snap.select( "#placeholder_surface" );
                    var placeholder_equation = snap.select( "#placeholder_equation" );
                    var sp_bbox = placeholder_surface.getBBox();
                    var ep_bbox = placeholder_equation.getBBox();
                    placeholder_surface.remove();
                    placeholder_equation.remove();

                    var image = snap.image( image_url, sp_bbox.x, sp_bbox.y, sp_bbox.w, sp_bbox.h );
                    image.node.setAttribute( "preserveAspectRatio", "xMidYMid" );

                    var equationSVGNode = Snap( document.getElementById( equation.root.inputID+'-Frame').firstChild );
                    var equationGroup = snap.group().append( equationSVGNode.clone() );

                    var e_bbox = equationGroup.getBBox();
                    var scale = Math.min( ep_bbox.w / e_bbox.w, ep_bbox.h / e_bbox.h );
                    equationGroup.transform( "t" + ( ep_bbox.x - e_bbox.x + 0.5 * ( ep_bbox.w - e_bbox.w * scale ) ) + "," + ( ep_bbox.y - e_bbox.y + 0.5 * ( ep_bbox.h - e_bbox.h * scale ) ) + "s" + scale + "," + scale + "," + e_bbox.x + "," + e_bbox.y );

                    return svgElement;
                }

                function htmlEscape( str ) {
                    return String( str )
                        .replace(/&/g, '&amp;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                }

                function createSVG( imageURL, tex, callback )
                {
                    // tidy up template
                    var template = document.getElementById( "template" );
                    while( template.firstChild && template.firstChild.nodeName.toUpperCase() !== "SVG" )
                        template.removeChild(template.firstChild );

                    // wipe drawing and clone template into it
                    var drawing = document.getElementById( "drawing" );
                    while( drawing.firstChild )
                        drawing.removeChild(drawing.firstChild);
                    drawing.appendChild( template.firstChild.cloneNode( true ) );

                    // enqueue MathJax job
                    MathJax.Hub.Queue( function() {
                        equation = MathJax.Hub.getAllJax("MathOutput")[0];
                        image_url = imageURL;
                        external_callback = callback;
                        MathJax.Hub.Queue(['Text', equation, tex, mathjaxCallback ]);
                    });
                }
            </script>
            <script>
                function testRun() {
                    createSVG(
                        "http://localhost:8888/tmp.png",
                        "x^{19}-36\\cdot x^7\\cdot y^2+126\\cdot x^5\\cdot y^4-84\\cdot x^3\\cdot y^6+9\\cdot x\\cdot y^8\
                            +64\\cdot z^9-9\\cdot x^8+126\\cdot x^6\\cdot y^2-126\\cdot x^2\\cdot y^6+9\\cdot y^8+\
                            27\\cdot x^7-27\\cdot x^5\\cdot y^2-135\\cdot x^3\\cdot y^4-81\\cdot x\\cdot y^6-144\\cdot z^7\
                            -21\\cdot x^6-225\\cdot x^4\\cdot y^2+45\\cdot x^2\\cdot y^4-39\\cdot y^6-36\\cdot x^5+\
                            72\\cdot x^3\\cdot y^2+108\\cdot x\\cdot y^4+108\\cdot z^5+54\\cdot x^4+108\\cdot x^2\\cdot y^2\
                            +54\\cdot y^4+9\\cdot x^3-27\\cdot x\\cdot y^2-30\\cdot z^3-27\\cdot x^2-27\\cdot y^2+\
                            2.25\\cdot z+4.25=0",
                        function(){}
                    );
                }
                if( !navigator.userAgent.startsWith( "SURFER" ) ) testRun();
        	</script>
    </body>
</html>
