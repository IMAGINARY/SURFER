<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                jax: ["input/TeX","output/SVG", "output/PreviewHTML"],
                extensions: ["tex2jax.js"],
                TeX: {
                    extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
                },
                SVG: {
                    linebreaks: { automatic: true },
                    font: "TeX",
                    blacker: 0.1,
                    useFontCache: true,
                    useGlobalCache: false,
                    EqnChunkDelay: 100
                }
            });
            MathJax.Hub.Register.StartupHook("End Jax",function () {
                return MathJax.Hub.setRenderer( "SVG" );
            });
        </script>
        <style type="text/css">
            #template, #drawing {
                display: inline-block;
                border: solid 1px black;
            }

            #template > svg, #drawing > svg {
                display: block;
            }

            #placeholder_surface, #placeholder_equation {
                fill: LightGray;
            }

            #template {
                display: none;
            }

            #equation_wrapper {
                background-color:red;
                width: 30ex;
            }

            #equation_wrapper_wrapper:not(.debug) {
                width: 0px;
                height: 0px;
                overflow: hidden;
            }

            #equation_wrapper_wrapper.debug {
                width: 100%;
                height: initial;
                overflow: scroll;
            }

            body {
                margin: 0px;
            }
        </style>
    </head>
    <body>
        <div id="equation_wrapper_wrapper" class="nodebug">
            <div id="equation_wrapper">$$0$$</div>
        </div>
        <script>
            var allLibs = {
                "SURFER": [
                    "fileinjar:///META-INF/resources/webjars/Snap.svg/0.4.1/snap.svg-min.js",
                    "fileinjar:///META-INF/resources/webjars/mathjax/2.7.1/MathJax.js"
                ],
                "online": [
                    "https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js",
                    "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"
                ]
            };
            var libs = allLibs[ navigator.userAgent.startsWith( "SURFER" ) ? "SURFER" : "online" ];
            libs.forEach( function( lib ) {
                // The following loads the script synchronously.
                // It is bad practice, but at least it works.
                var script = document.createElement('script');
                script.setAttribute( 'src', lib );
                script.setAttribute( 'type', 'text/javascript' );
                document.write( script.outerHTML );
            });
        </script>
        <div id="template">
            <svg height="848.5281374238571" width="600" xmlns:svgjs="http://svgjs.com/svgjs" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg">
                <rect x="25" y="60" height="550" width="550" id="placeholder_surface"></rect>
                <rect x="45" y="650" height="150" width="510" id="placeholder_equation"></rect>
            </svg>
        </div>
        <div id="drawing"></div>
        <script type="text/javascript">
                function svgSourceWithXlinkHref( svgElem )
                {
                    // work on a copy of the SVG node
                    svgElem = svgElem.cloneNode( true );

                    // fix image tag: replace href with xlink:href
                    var images = svgElem.querySelectorAll( "image" );
                    images.forEach( function( image ) {
                        image.setAttribute( "xlink:href", image.getAttribute( "href" ) );
                        image.removeAttribute( "href" );
                    });

                    // fix embedded svg: replace href with xlink:href
                    let equationSvgElem = svgElem.querySelector( "svg.equation" );
                    equationSvgElem.setAttribute( "xmlns", "http://www.w3.org/2000/svg" );
                    equationSvgElem.setAttribute( "version", "1.1" );

                    svgElem.querySelectorAll( "use").forEach(
                        function(e) {
                            e.setAttribute( "xlink:href", e.getAttribute( "href" ) );
                            e.removeAttribute( "href" );
                        }
                    );

                    return svgElem.outerHTML;
                }

                function mathJaxCallback( p ) {
                    var svgEquationElement = p.equationWrapperElem.querySelector( 'svg' );
                    var equationBBox = getSvgElementBBox( svgEquationElement, "g" );
                    var isMultiLine = p.mathJaxEquation.root.isMultiline;
                    if( !isMultiLine || bBoxAspectRatio( p.placeholderBBox ) < bBoxAspectRatio( equationBBox ) )
                    {
                        var svgElem = document.querySelector( '#drawing svg' );
                        composeSVG( p.targetSvgElem, p.imageUrl, svgEquationElement, isMultiLine );
                        p.externalCallback( svgElem );
                    }
                    else
                    {
                        var increment = "5ex";
                        var computedWidth = Number.parseFloat( window.getComputedStyle( p.equationWrapperElem.querySelector( "svg" ) ).width.replace( "px", "" ) );
                        p.equationWrapperElem.style.width = "calc(" + computedWidth + "px + " + increment + ")";
                        console.log( "typesetting again at width of " + window.getComputedStyle( p.equationWrapperElem ).width );
                        MathJax.Hub.Queue(['Reprocess', p.mathJaxEquation, [ mathJaxCallback, p ] ]);
                    }
        		}

                function bBoxAspectRatio( bbox ) {
                    return bbox.w / bbox.h;
                }

                function getSvgBBox( svgElemOrQuerySelector )
                {
                    return Snap( svgElemOrQuerySelector ).getBbox();
                }

                function getSvgElementBBox( svgElemOrQuerySelector, elementQuerySelector )
                {
                    return Snap( svgElemOrQuerySelector )
                        .select( elementQuerySelector )
                        .getBBox();
                }

                function composeSVG( svgElement, imageUrl, svgEquationElement, isMultiLine )
                {
                    var snap = Snap( svgElement );
                    var placeholder_surface = snap.select( "#placeholder_surface" );
                    var placeholder_equation = snap.select( "#placeholder_equation" );
                    var sp_bbox = placeholder_surface.getBBox();
                    var ep_bbox = placeholder_equation.getBBox();
                    placeholder_surface.remove();
                    placeholder_equation.remove();

                    var image = snap.image( imageUrl, sp_bbox.x, sp_bbox.y, sp_bbox.w, sp_bbox.h );
                    image.node.setAttribute( "preserveAspectRatio", "xMidYMid" );

                    var equationSVGNode = Snap( svgEquationElement ).clone();
                    equationSVGNode.attr( { class: "equation" } );

                    var equationGroup = snap.group().append( equationSVGNode );

                    equationGroup.attr( { fill: "#000000", stroke: "#000000" } ); // set text color to black

                    var e_bbox = equationGroup.getBBox();
                    var singleLineFactor = isMultiLine ? 1.0 : 0.5;
                    var scale = Math.min( ep_bbox.w / e_bbox.w, singleLineFactor * ep_bbox.h / e_bbox.h );
                    equationGroup.transform( "t" + ( ep_bbox.x - e_bbox.x + 0.5 * ( ep_bbox.w - e_bbox.w * scale ) ) + "," + ( ep_bbox.y - e_bbox.y + 0.5 * ( ep_bbox.h - e_bbox.h * scale ) ) + "s" + scale + "," + scale + "," + e_bbox.x + "," + e_bbox.y );

                    return svgElement;
                }

                function createSVG( imageUrl, tex, callback )
                {
                    // avoid line breaks around the equation sign
                    tex = tex.replace( "=", "\\mmlToken{mo}[linebreak=\"nobreak\"]{=}" );

                    // wipe drawing and clone template into it
                    var drawing = document.getElementById( "drawing" );
                    while( drawing.firstChild )
                        drawing.removeChild(drawing.firstChild);
                    drawing.appendChild( document.querySelector( "#template svg" ).cloneNode( true ) );

                    // enqueue MathJax job
                    MathJax.Hub.Queue( function() {
                        let callbackParams = {
                            placeholderBBox: getSvgElementBBox( "#template svg", "#placeholder_equation" ),
                            equationWrapperElem: document.querySelector( "#equation_wrapper" ),
                            mathJaxEquation: MathJax.Hub.getAllJax( "equation_wrapper" )[0],
                            targetSvgElem: drawing.querySelector( "svg" ),
                            imageUrl: imageUrl,
                            externalCallback: callback
                        };
                        MathJax.Hub.Queue(
                            [ 'Text', callbackParams.mathJaxEquation, tex ],
                            [ mathJaxCallback, callbackParams ]
                        );
                    });
                }
            </script>
            <script>
                function testRun() {
                    createSVG(
                        "http://localhost:8888/tmp.png",
                        "x^{19}-36\\cdot x^7\\cdot y^2+126\\cdot x^5\\cdot y^4-84\\cdot x^3\\cdot y^6+9\\cdot x\\cdot y^8\
                            +64\\cdot z^9-9\\cdot x^8+126\\cdot x^6\\cdot y^2-126\\cdot x^2\\cdot y^6+9\\cdot y^8+\
                            27\\cdot x^7-27\\cdot x^5\\cdot y^2-135\\cdot x^3\\cdot y^4-81\\cdot x\\cdot y^6-144\\cdot z^7\
                            -21\\cdot x^6-225\\cdot x^4\\cdot y^2+45\\cdot x^2\\cdot y^4-39\\cdot y^6-36\\cdot x^5+\
                            72\\cdot x^3\\cdot y^2+108\\cdot x\\cdot y^4+108\\cdot z^5+54\\cdot x^4+108\\cdot x^2\\cdot y^2\
                            +54\\cdot y^4+9\\cdot x^3-27\\cdot x\\cdot y^2-30\\cdot z^3-27\\cdot x^2-27\\cdot y^2+\
                            2.25\\cdot z+4.25=0",
                        function(){}
                    );
                }
                if( !navigator.userAgent.startsWith( "SURFER" ) ) testRun();
        	</script>
    </body>
</html>
