<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                jax: ["input/TeX","output/SVG", "output/PreviewHTML"],
                extensions: ["tex2jax.js"],
                TeX: {
                    extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
                }
            });
            MathJax.Hub.Config({
                SVG: {
                    linebreaks: { automatic: true },
                    font: "TeX",
                    blacker: 0.1,
                    useFontCache: true,
                    useGlobalCache: false,
                    EqnChunkDelay: 100
                }
            });
            MathJax.Hub.Register.StartupHook("End Jax",function () {
                return MathJax.Hub.setRenderer( "SVG" );
            });
        </script>
    </head>
    <body>
         <script>
            var allLibs = {
                "SURFER": [
                    "fileinjar:///META-INF/resources/webjars/Snap.svg/0.4.1/snap.svg-min.js",
                    "fileinjar:///META-INF/resources/webjars/mathjax/2.7.1/MathJax.js"
                ],
                "online": [
                    "https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js",
                    "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"
                ]
            };
            var libs = allLibs[ navigator.userAgent.startsWith( "SURFER" ) ? "SURFER" : "online" ];
            libs.forEach( function( lib ) {
                // The following loads the script synchronously.
                // It is bad practice, but at least it works.
                var script = document.createElement('script');
                script.setAttribute( 'src', lib );
                script.setAttribute( 'type', 'text/javascript' );
                document.write( script.outerHTML );
            });
        </script>
        <div id="template">
            <svg height="848.5281374238571" width="600" xmlns:svgjs="http://svgjs.com/svgjs" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg">
                <defs id="SvgjsDefs1001"></defs>
                <rect fill="#bbbbbb" height="848.5281374238571" width="600" id="SvgjsRect1007"></rect>
                <rect fill="#777777" y="60" height="600" width="600" id="placeholder_surface"></rect>
                <rect fill="#777777" y="690" height="120" width="600" id="placeholder_equation"></rect>
            </svg>
        </div>
        <div id="drawing">
        </div>
        <textarea id="source" cols="100" rows="5"></textarea>
        <script>
            function createTemplate()
            {
                var size = 600.0;
                var draw = SVG( 'drawing' ).size( size, size * Math.sqrt( 2 ));
                var page = draw.rect( size, size * Math.sqrt( 2 ) ).attr( { fill: '#BBB' } );
                var placeholder_surface = draw.rect( size, size ).attr( { y: 0.1 * size, fill: '#777', id: 'placeholder_surface' } );
                var placeholder_equation = draw.rect( size, 0.2 * size ).attr( { y: 1.15 * size, fill: '#777', id: 'placeholder_equation' } );
                document.getElementById( "source" ).value = draw.svg();
            }
        </script>

        <div id="equation_wrapper" style="background-color:red; width:30ex;">$$0$$</div>

        <script type="text/javascript">
                var image_url = null;
                var equation_wrapper = document.getElementById('equation_wrapper');
        		var equation = null;
                var width_ex = 30;
                var external_callback = null;

                function mathjaxCallback() {
    //    			equation = MathJax.Hub.getAllJax("MathOutput")[0];
                    if( isLaTeXOneLine() || getPlaceholderAspectRatio() - getLaTeXAspectRatio() < 0.1 )
                    {
                        svgSource = composeSVG();
                        document.getElementById( "source" ).value = svgSource;
                        external_callback( svgSource );
                    }
                    else
                    {
                        width_ex += 5;
                        equation_wrapper.style.width = width_ex + "ex";
                        console.log( "typesetting again at width of " + width_ex + "ex" );
                        MathJax.Hub.Queue(['Reprocess', equation, mathjaxCallback ]);
                    }
        		}

                function getPlaceholderAspectRatio()
                {
                    var bbox = Snap( document.getElementById( "template" ).children[ 0 ] )
                        .select( "#placeholder_equation" )
                        .getBBox();
                    return bbox.w / bbox.h;
                }

                function isLaTeXOneLine()
                {
                    // I am more or less guessing here, but it should work for simple
                    // polynomial equations
                    return getLaTeXBBox().h < 1500;
                }

                function getLaTeXBBox()
                {
                    return Snap( document.getElementById(equation.root.inputID+'-Frame').firstChild ).getBBox();
                }

                function getLaTeXAspectRatio()
                {
                    var bbox = getLaTeXBBox();
                    return bbox.w / bbox.h;
                }

                function composeSVG()
                {
                    var snap = Snap( document.getElementById( "template" ).children[ 0 ] );
                    var placeholder_surface = snap.select( "#placeholder_surface" );
                    var placeholder_equation = snap.select( "#placeholder_equation" );
                    var sp_bbox = placeholder_surface.getBBox();
                    var ep_bbox = placeholder_equation.getBBox();
                    placeholder_surface.remove();
                    placeholder_equation.remove();

                    var image = snap.image( image_url, sp_bbox.x, sp_bbox.y, sp_bbox.w, sp_bbox.h );

                    var equationSVGNode = Snap( document.getElementById( equation.root.inputID+'-Frame').firstChild );
                    var equationGroup = snap.group().append( equationSVGNode.clone() );

                    var e_bbox = equationGroup.getBBox();
                    var scale = Math.min( ep_bbox.w / e_bbox.w, ep_bbox.h / e_bbox.h );
                    equationGroup.transform( "t" + ( ep_bbox.x - e_bbox.x + 0.5 * ( ep_bbox.w - e_bbox.w * scale ) ) + "," + ( ep_bbox.y - e_bbox.y + 0.5 * ( ep_bbox.h - e_bbox.h * scale ) ) + "s" + scale + "," + scale + "," + e_bbox.x + "," + e_bbox.y );

                    // fix image tag: replace href with xlink:href
                    return snap.outerSVG().replace( /(<image[^>]* )href=/g, "$1xlink:href=" );
                }

                function htmlEscape( str ) {
                    return String( str )
                        .replace(/&/g, '&amp;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                }

                function createSVG( imageURL, tex, callback )
                {
                    MathJax.Hub.Queue( function() {
                        equation = MathJax.Hub.getAllJax("MathOutput")[0];
                        image_url = imageURL;
                        external_callback = callback;
                        MathJax.Hub.Queue(['Text', equation, tex, mathjaxCallback ]);
                    });
                }
            </script>
            <script>
                /*
                var url = new URL( window.location.href );
                var formula = url.searchParams.get( "formula" );
                var image = url.searchParams.get( "image" );
                createSVG(
                    image,
                    formula,
                    function( svgSource ) { console.log( svgSource ); }
                );
                */
        	</script>
    </body>
</html>
